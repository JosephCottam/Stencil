STREAM: File
NAME: Stocks
TUPLE_SIZE: 6
SEPARATOR: ,
SOURCE: ./google_stocks.csv
SKIP: 1
STRICT: true

import Dates

stream Stocks(Date, Open)


stream AlignedStocks(Date, Open)
from Stocks
  Date : Parse[f:"dd-MMM-yy"](Date)
  Open : Open

layer Ticker["POLY_POINT"]		/*Poly-piont is a group of groups of line segments.*/
guide
   axis Linear from Y
   axis[unit: "MONTH"] Date from X
     label.TEXT: Parse.format[f:"MMM yy"](Input)

from AlignedStocks
   ID: AutoID(4) -> *
   GROUP: MultiResult("Base", "Avg20", "Avg30", "AvgAll") -> *
   ORDER: Count()
   X: TimeStep(Date)
   Y: MapApply(@Echo, @Avg20, @Avg30, @AvgAll, Open) -#> *
   PEN: Stroke{1}
   PEN_COLOR: 
		ToTuple("BLUE", "LIME,150", "CRIMSON,150", "ORANGE,150") 
			-> Map(@Color, ToTuple.*) -> *

operator Avg20 : Range["-30..-10"](@Mean)
operator Avg30 : Range["-30..n"](@Mean)
operator AvgAll : Range[ALL](@Mean)


operator Ids : Count 

operator TimeStep (T) -> (S)
default => (S) : Range[ALL](@DateMin, T) 
                   -> DateDiff("DAYS", Range, T) 
                   -> Mult(_, 3)

operator DateMin : Min[c:"Date"]  
