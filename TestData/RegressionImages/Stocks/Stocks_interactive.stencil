STREAM: File
NAME: Stocks
TUPLE_SIZE: 6
SEPARATOR: ,
SOURCE: /Users/jcottam/Documents/workspace/Stencil/TestData/RegressionImages/Stocks/google_stocks.csv
SKIP: 1
STRICT: true
STREAM: Mouse
NAME: Mouse
FREQUENCY: -2147483648

import Dates 

stream Stocks(Date, Open)
stream Mouse(X, Y, DELTA_X, DELTA_Y, BUTTON, SHIFT, CNTRL, COMMAND, CLICK_COUNT)

stream AlignedStocks(Date, Open)
from Stocks
  Date : Parse[f:"dd-MMM-yy"](Date)     /*@\label{stocks:parseDate}@*/
  Open : Open

layer Ticker["POLY_POINT"]		/*Poly-piont is a group of groups of line segments.*/
guide
   axis Linear from Y
   axis[unit: "MONTH"] Date from X
     label.TEXT: Parse.format[f:"MMM yy"](Input)    /*@\label{stocks:monthSample}@*/

from AlignedStocks
   ID: TimeStep(Date)
   GROUP: "Google"
   ORDER: Count()
   X: TimeStep(Date)
   Y: Open  
   PEN: Stroke{1}
   PEN_COLOR: Color{BLUE}

layer Averages["POLY_POINT"]
from AlignedStocks
   ID: Ids()
   GROUP: "Google_30"
   ORDER: Count()
   X: TimeStep(Date)
   Y: Range["-30..n"](@Mean, Open)	    /*Average the most recent 30 values.*/
   PEN: Stroke{1}
   PEN_COLOR: Color{LIME,150}
from AlignedStocks
   ID: Ids()
   GROUP: "Google_ALL"
   ORDER: Count()
   X: TimeStep(Date)
   Y: Range[ALL](@Mean, Open)		    /*Average all values.*/
   PEN: Stroke{1}
   PEN_COLOR: Color{CRIMSON,150}
from AlignedStocks
   ID: Ids()
   GROUP: "Google_20"
   ORDER: Count()
   X: TimeStep(Date)
   Y: Range["-30 .. -10"](@Mean, Open) /*Average that lags by 10 and includes 20 values.*/
   PEN: Stroke{1}
   PEN_COLOR: Color{ORANGE,150}


layer Selected["TEXT"]			/*@\label{stocks:beginInteractive}@*/
from Mouse
  local(point) : Nearest(X,3)
  ID : "Selected"
  TEXT: local.point
  REGISTRATION: "LEFT"
  IMPLANT: "POINT"
  (X, Y) :[FullMax] Add(canvas.X, canvas.WIDTH) 
           -> Max(canvas.X, local.point) -> Min(FullMax, _) 
           -> Ticker.find(_) -> Add(50, Ticker.Y) -> (Ticker.X, _)

layer Highlight["LINE"]
from Mouse
  ID : "Highlight"
  (X1, X2) : Nearest(X, 3) -> (_, _)
  Y1 : Ticker.bounds() -> Sub(Ticker.Y, Ticker.H) 
  Y2 : Ticker.bounds() -> Ticker.Y
  PEN : Stroke{3}
  PEN_COLOR: Color{BLUE, 100}		/*@\label{stocks:endInteractive}@*/

operator Ids : Count

operator TimeStep (T) -> (S)
default => (S) : Range[ALL](@DateMin, T) 
                   -> DateDiff("DAYS", Range, T) 
                   -> Mult(_, 3)

operator DateMin : Min[c:"Date"]  
