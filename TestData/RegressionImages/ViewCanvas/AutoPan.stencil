STREAM: File
NAME: Stocks
HEADER: Date,Open,High,Low,Close,Volume
SEPARATOR: ,
SOURCE: /Users/jcottam/Documents/workspace/Stencil/Stencil/TestData/RegressionImages/ViewCanvas/google_stocks.csv
SKIP: 1
STRICT: true
STREAM: Mouse
NAME: Mouse
FREQUENCY: -2147483648

import ViewCanvas

stream Stocks(Date, Open)
stream Mouse(X, Y, BUTTON, SCREEN_X, SCREEN_Y, DELTA_X, DELTA_Y, CLICK_COUNT, CTRL, ALT, SHIFT, META, TYPE)

order (Stocks | Mouse)

layer Ticker[POLY_LINE]
from Stocks
    ID : "Google"   
    X.new: TimeStep(Date) 
    Y.new: Mult(Open, -1)
    STROKE_WEIGHT: 1
    STROKE_COLOR: @Color{BLUE}
from Stocks
    view(HEIGHT, Y) :(canvas[HEIGHT], canvas[Y])
from Stocks
    filter(Margin < 50)
    filter(TimeStep < RIGHT)
    prefilter(TimeStep, Margin, RIGHT) : 
        [Right] TranslateRegistration("TOP_LEFT", view[X], view[Y], view[WIDTH], view[HEIGHT], "RIGHT") ->
        [Time] TimeStep(Date) -> Sub(Right[X], _) -> (Time[VALUE], VALUE, Right[X]) 
    
    view(X): Add(3, view[X])

layer Nav
from Mouse
    filter(BUTTON = 1)
    filter(SHIFT !~ "true")
    view(X) : ScreenToCanvasDimension(DELTA_X,0) -> Sub(view[X], Width)
from Mouse
    filter(BUTTON = 1)
    filter(SHIFT =~ "true")
    view(Y): ScreenToCanvasDimension(0,DELTA_Y) -> Sub(Height, view[Y])
from Mouse
    filter(CLICK_COUNT = 3)
    filter(BUTTON = 1)
    view(X, Y, WIDTH, HEIGHT) : (canvas[X], canvas[Y], canvas[WIDTH], canvas[HEIGHT])

operator TimeStep (Date) -> (VALUE)
    ALL => VALUE : Index(Date) -> Mult(3, VALUE)
