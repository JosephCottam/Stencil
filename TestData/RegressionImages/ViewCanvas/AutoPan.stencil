STREAM: File
NAME: Stocks
TUPLE_SIZE: 6
SEPARATOR: ,
SOURCE: ./google_stocks.csv
SKIP: 1
STRICT: true
STREAM: Mouse
NAME: Mouse
FREQUENCY: -2147483648

import ViewCanvas

stream Stocks(Date, Open)
stream Mouse(X, Y, BUTTON, SCREEN_X, SCREEN_Y, DELTA_X, DELTA_Y, CLICK_COUNT, CTRL, ALT, SHIFT, META, TYPE)

order (Stocks | Mouse)

view 
from Stocks
    (HEIGHT, Y) : (canvas.HEIGHT, canvas.Y)
from Stocks
    filter(prefilter.Margin < 50)
    filter(prefilter.TimeStep < prefilter.RIGHT)
    prefilter(TimeStep, Margin, RIGHT) : 
        [Right] TranslateRegistration("TOP_LEFT", view.X, view.Y, view.WIDTH, view.HEIGHT, "RIGHT") ->
        [Time] TimeStep(Date) -> Sub(Right.X, _) -> (Time.VALUE, Sub, Right.X) 
    
    X: Add(3, view.X)
from Mouse
    filter(BUTTON = 1)
    filter(SHIFT !~ "true")
    X : [dim] ScreenToCanvasDimension(DELTA_X,0) -> Sub(view.X, dim.Width)
from Mouse
    filter(BUTTON = 1)
    filter(SHIFT =~ "true")
    Y: [dim] ScreenToCanvasDimension(0,DELTA_Y) -> Sub(dim.Height, view.Y)
from Mouse
    filter(CLICK_COUNT = 3)
    filter(BUTTON = 1)
    (X, Y, WIDTH, HEIGHT) : (canvas.X, canvas.Y, canvas.WIDTH, canvas.HEIGHT)



layer Ticker["POLY_POINT"]
from Stocks
    ID: Count()
    GROUP : "Google"   
    X: TimeStep(Date) 
    Y: Open
    PEN: @Stroke{1}
    PEN_COLOR: @Color{BLUE}

operator TimeStep (Date) -> (VALUE)
    default => VALUE : Index(Date) -> Mult(3, Index)
