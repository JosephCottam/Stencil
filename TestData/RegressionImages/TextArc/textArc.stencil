STREAM: File
NAME: RawLines
HEADER: text
SEPARATOR: $^
SOURCE: ./AliceInWonderland.txt
SKIP: 0
STRICT: true

import Layouts
import Geometry as Geo

stream RawLines(text)

stream Lines (line, text)
from RawLines
   line: Count()
   words: text

stream RawWords (line, word)
from Lines
   line: line
   word: Split(text, "\\s+") >> Strip(_) -> ToLower(_)
   
stream Words (line, word)
from RawWords
   filter(stopWord !~ "true", word !~ "")
   prefilter(stopWord) : StopWords(word)
   line: line
   word: word

stream PrimeCenter ()
from Words
 () : LineIndex.query(word) -> ExtendTuple(_, line) -> LineIndex(word, *)
 () : WordCount(word)

layer Border["TEXT"]
from Lines
   ID: line
   TEXT: text
   (X,Y):* Layout(line) 


layer Center["TEXT"]
from Words
   ID: word
   TEXT: word
   (X,Y):* Centroid(word) -> Contract(X,Y) 
   REGISTRATION: "CENTER"
   (COLOR, FONT):* 
        [count] WordCount.query(word) -> Max[range: ALL](_) -> 
        [freq]  Divide(count[_], _) -> 
		[color] HeatScale[hot: "BLUE", cold: "GRAY30"](freq[_]) ->
				Scale[min: 50, max:1000](freq[_]) -> @Font{{_}} -> (color[_],_)

operator WordCount : Count

operator LineIndex : Dict[fields: "lines"]

/*TODO: Add a labeling facility to Fold so LineIndex/Split/Layout only need to be done once.*/
operator Centroid (word) -> (X,Y)
  (ALL) =>
    (X): LineIndex.query(word) -> Get(*,0) >> Layout.query(_) >-
            Select[field: 0](*) -> Mean[range: LAST](LAST)
    (Y): LineIndex.query(word) -> Get(*,0) >> Layout.query(_) >-
            Select[field: 1](*) -> Mean[range: LAST](LAST)

/*TODO: Do two circular layouts of different radii and a linear interpolation between them as values move around the circle.*/            
operator Layout : CircularLayout[start: 0, size: 10, ratio: .75]
operator Contract : Geo::Scale[by: .94]
