STREAM: File
NAME: Deaths
TUPLE_SIZE: 3
SEPARATOR: \s*,\s*
SOURCE: /Volumes/scratch/jcottam/Stencil/Stencil/TestData/RegressionImages/Nightingale/NightingaleCrimeaSplit.csv
SKIP: 1
STRICT: true

import Dates
import Geometry

stream Deaths(date, type, count)

layer Rose["SLICE"]
guide
  legend[X: -75, Y: 50] from FILL_COLOR
    label.REGISTRATION: "BOTTOM_LEFT"
  pointLabels from ID
    TEXT: ParseLabel(ID) 		/*@\label{rose:postProcessStart}@*/
    (X,Y): LabelLayout(ID, OUTER) 
    REGISTRATION: "CENTER"
    FONT: @Font{4}          	/*@\label{rose:postProcessEnd}@*/

from Deaths
   local(month, year) : Parse[f:"M/yyyy"](date) -> (Parse.month, Parse.year)
   ID: Concatenate(type, ":", local.month)	
   FILL_COLOR: ColorBy(type)
   PEN: @Stroke{.5}
   PEN_COLOR: @Color{Gray70}
   SIZE:* MonthMin(local.month, count) 
				-> Scale[min:0, max:250](count)
   Z: Mult(-1, count)
   (X,Y): (0,0)
   (START, END): Sub1(local.month) -> Partition(_)  
    
operator ColorBy (t) -> (C)
   (t=~"wounds") => C:@Color{LightPink}
   (t=~"other") => C:@Color{DarkGray}
   (t=~"disease") => C:@Color{LightBlue}

operator MonthMin : Split[1](@FullMin["Integer"])

operator ParseLabel(id) -> (text)
   (id =~ ".*dise.*") => text: IndexOf(id,":") -> Add1(_) 
									-> Substring(id, _, -1) 
									-> Parse.reformat(_, "M", "MMM")         
   default => text: ""

operator Partition(n) -> (start, end)
   default => (start, end): Sub(12, n) -> [n] Sub(_,4) -> 
                          [end] Mult(30, n) ->
                          Add1(n) -> Mult(30,_) -> (_,end)

operator LabelLayout(id, outer) -> (X,Y)
  (id =~ "") => (X,Y) : (0,0)
  default => (X,Y) :  [origin] Point(0,0) 
							 -> ParseLabel(id) 
							 -> MonthMin(_, 0) 
							 -> Distance(origin.*, outer)
							 -> Max(50.0, _) 
							 -> ProjectAlong(origin.*, outer, _) 
