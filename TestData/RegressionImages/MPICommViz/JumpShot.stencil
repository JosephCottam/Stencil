STREAM: File
NAME: trans
HEADER: op source dest start end size G r g b
SEPARATOR: \s+
SOURCE: ./diss_16.viz
SKIP: 0
STRICT: false
STREAM: File
NAME: overheads
HEADER: op rank cpu start end r g b
SEPARATOR: \s+
SOURCE: ./diss_16.viz
SKIP: 0
STRICT: false

stream ranks(rank, label)
stream overheads(op, rank, cpu, start, end, r,g,b, skewedStart, skewedEnd)
stream trans(op, source, dest, start, end, size, G, r,g,b, skewedStart, skewedEnd) 

order ranks > (overheads | trans)

layer labels[TEXT]
from ranks
	ID: label
	TEXT: label
	X: -10
	Y: Layout(rank)
	COLOR: @Color{GRAY70}
	REGISTRATION: "RIGHT"
from overheads
	filter (start > margin)
	prefilter(start, margin): Spacer.query() -> Add(5000,_) -> (start, VALUE)
	
	ID: start
	TEXT: start
	X: Timescale(skewedStart)
	Y: -10    
	COLOR: @Color{GRAY70}
	REGISTRATION: "LEFT"
	ROTATION: "VERTICAL"
	() : Spacer.map(start)
from overheads
	filter (end > margin)
	prefilter(end, margin): Spacer.query() -> Add(5000,_) -> (end, VALUE)
	
	ID: end
	TEXT: end
	X: Timescale(skewedEnd)
	Y: -10    
	COLOR: @Color{GRAY70}
	REGISTRATION: "LEFT"
	ROTATION: "VERTICAL"
	() : Spacer.map(end)

operator Spacer base Max[range: ALL]

layer baseline[LINE]
from overheads
	ID: rank
	X.2: Timescale(skewedStart) -> Max[range: ALL](_)
	PEN_COLOR: @Color{Gray90}
	(Y.1, Y.2): Layout(rank) -> (_,_)
from trans
	ID: source
	X.2: Timescale(skewedStart) -> Max[range: ALL](_) ->(_,_)
	PEN_COLOR: @Color{Gray90}
	(Y.1,Y.2): Layout(source) ->(_,_)


layer compressions[SHAPE]
from overheads
	filter(op =~ "clocalop")
	ID: Count()
	Y: Layout(rank) 
	X: Timescale(skewedStart)
	FILL_COLOR : @Color{Purple}
	SIZE: 15
	REGISTRATION: "CENTER"
	
layer overhead[LINE]
from overheads
	filter(op !~ "clocalop") 
	ID: Count()
	(Y.1, Y.2): Layout(rank) -> (_,_)
	X.1: Timescale(skewedStart)
	X.2: Timescale(skewedEnd)
	PEN_COLOR : ColorByOp(op)
    PEN: WeightByOp(op)


layer coms[LINE]
from trans
    ID: Counter()
	Y.1: Layout(source)
	Y.2: Layout(dest)
	X.1: Timescale(skewedStart)
	X.2: Timescale(skewedEnd)
	PEN_COLOR : ColorByOp(op)
	CAP2: "ARROW"

operator ColorByOp(op) -> (C)
	(op =~ "osend") => C: @Color{SlateBlue}
	(op =~ "orecv") => C: @Color{MediumSlateBlue}
	(op =~ "transmission") => C: @Color{FireBrick}
	ALL => C: @Color{BLACK, .5}

operator WeightByOp(op) -> (W)
	(op =~ "osend") => W : @Stroke{1}
 	(op =~ "orecv") => W : @Stroke{1}
	(op =~ "transmission") => W: @Stroke{5}
	ALL => W: @Stroke{2}
   
	
operator Layout (rank)->(Y)
  ALL => (Y) : Mult(20, rank)
 

operator Timescale(time) -> (time)
  ALL => time : Div(time, 50)
