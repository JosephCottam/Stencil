 <project name="TestStencil" default="RunTests">
    <target name="RunTests" depends="JUnit"/>
    
    <target name="CleanUpTests">
        <delete failonerror="false"><fileset dir="testResults" includes="**/TEST_*"/></delete>
    </target>
    
    <target name="MakeJar">
       <ant antfile="./build/Deploy.xml" inheritRefs="true" target="CompiledJar"/>
    </target>
    
    <target name="OneTest" depends="CleanUpTests,MakeJar">
        <tstamp><format property="now" pattern="ddMMMyyyy HH:mm"/></tstamp>
        <property name="results" location="./testResults/${now}" />

        <move file="Stencil.jar" toDir="TestData"/>
        <mkdir dir="${results}"/>

        
        <junit fork="yes" dir="../">
            <formatter type="plain"/>

            <classpath>
                <pathelement location="./TestData/Stencil.jar"/>
                <pathelement path="${java.class.path}"/>
                <pathelement path="."/>
                <fileset dir="${runtimeLibrary}" includes="*.jar"/>
            </classpath>
            
            <batchtest todir="${results}">
                <fileset dir="./bin/">
                    <include name="**/*TestProjection.class"/>
                </fileset>
            </batchtest>
        </junit>
        
        <delete file="TestData/Stencil.jar"/>
    </target>
    
    <target name="JUnit" depends="CleanUpTests,MakeJar">
        <tstamp><format property="now" pattern="ddMMMyyyy HH:mm"/></tstamp>
        <property name="base" location="./testResults/${now}" />
        <property name="results" location="${base}/raw" />
        <property name="report" location="${base}" />

        <move file="Stencil.jar" toDir="TestData"/>
        <delete failonerror="false" dir="${base}"/>
        <mkdir dir="${base}"/>
        <mkdir dir="${results}"/>
        <mkdir dir="${report}"/>

        
        <junit fork="yes" dir="./">
            <formatter type="xml"/>

            <classpath>
                <pathelement location="./TestData/Stencil.jar"/>
                <pathelement path="${java.class.path}"/>
                <pathelement path="."/>
                <fileset dir="${runtimeLibrary}" includes="*.jar"/>
            </classpath>
            
            
            <batchtest todir="${results}">
                <fileset dir="./bin/">
                    <include name="**/*Test*.class"/>
                    <exclude name="**/*$*"/>
                    <exclude name="**/testUtilities/**"/>
                    <exclude name="**/examples/**"/>
                    <exclude name="**/StencilTestCase.*"/>
                </fileset>
            </batchtest>
        </junit>
        
        <delete file="TestData/Stencil.jar"/>
        
        <junitreport todir="${report}">
           <fileset dir="${results}">
               <include name="TEST-*.xml"/>
            </fileset>
    
           <report todir="${report}" format="frames"/>
        </junitreport>
        
    </target>

    <target name="JUnit-Singles" depends="CleanUpTests,MakeJar">
        <move file="Stencil.jar" toDir="TestData"/>
        
        <junit fork="yes" dir="./">
            <classpath>
                <pathelement location="./TestData/Stencil.jar"/>
                <pathelement path="${testsLocation}"/>
                <pathelement path="${java.class.path}"/>
                <pathelement path="."/>
                <fileset dir="${runtimeLibrary}" includes="*.jar"/>
            </classpath>
            <test name="stencil.unittests.TestConfigure"/>
            <formatter type="plain"/>
        </junit>
    </target>


	<!--GUnit tests--> 	
 	<target name="GUnit"> 
	 	<property name="testsLocation" location="bin/stencil/unittests/parser/string/grammars/" />

		<jar jarfile="${runtimeLibrary}/Stencil.jar" includes="*.class" basedir=".">
			<fileset dir="bin"/>
		</jar>

		<java classname="org.antlr.gunit.Interp" fork="yes" dir="${target}">
			<classpath>
				<pathelement path="${testsLocation}"/>
				<pathelement path="${java.class.path}"/>
				<pathelement path="."/>
			    <fileset dir="${runtimeLibrary}" includes="*.jar"/>
			</classpath>
			<arg value="${testsLocation}/Stencil.gunit"/>
		</java>
		<java classname="org.antlr.gunit.Interp" fork="yes" dir="${target}">
			<classpath>
				<pathelement path="${testsLocation}"/>
				<pathelement path="${java.class.path}"/>
				<pathelement path="."/>
			    <fileset dir="${runtimeLibrary}" includes="*.jar"/>
			</classpath>
			<arg value="${testsLocation}/SigilArgs.gunit"/>
		</java>
 		
 		<delete file="${runtimeLibrary}/Stencil.jar"/>
	</target>
 </project>