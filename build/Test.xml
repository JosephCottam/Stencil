 <project name="TestStencil" default="RunTests">
    <target name="RunTests" depends="JUnit"/>
    
    <target name="MakeJar">
       <ant antfile="./build/Deploy.xml" inheritRefs="true" target="CompiledJar"/>
    </target>
    
    
    <target name="JUnit" depends="MakeJar">
        <tstamp><format property="now" pattern="yyyyMMMdd_HH_mm"/></tstamp>
        <property name="base" location="./testResults/${now}" />
        <property name="results" location="${base}/raw" />
        <property name="report" location="${base}" />

        <move file="Stencil.jar" toDir="TestData"/>
        <delete failonerror="false" dir="${base}"/>
        <mkdir dir="${base}"/>
        <mkdir dir="${results}"/>
        <mkdir dir="${report}"/>

        
        <junit fork="yes" dir="./">
            <formatter type="xml"/>
        	<jvmarg value="-DtestDir=${base}"/>

            <classpath>
                <pathelement location="./TestData/Stencil.jar"/>
                <pathelement path="${java.class.path}"/>
                <pathelement path="."/>
                <fileset dir="${runtimeLibrary}" includes="*.jar"/>
                <fileset dir="${runtimeLibrary}/JUNG/" includes="*.jar"/>
            	<fileset dir="${runtimeLibrary}/twitter/" includes="*.jar"/>
            </classpath>
            
            
            <batchtest todir="${results}">
                <fileset dir="./bin/">
                    <include name="**/*Test*.class"/>
                    <exclude name="**/*$*"/>
                    <exclude name="**/testUtilities/**"/>
                    <exclude name="**/examples/**"/>
                    <exclude name="**/StencilTestCase.*"/>
                </fileset>
            </batchtest>
        </junit>
        
        <delete file="TestData/Stencil.jar"/>
        
        <junitreport todir="${report}">
           <fileset dir="${results}">
               <include name="TEST-*.xml"/>
            </fileset>
    
           <report todir="${report}" format="frames"/>
        </junitreport>
        
    </target>

    <target name="JUnit-Singles" depends="MakeJar">
        <move file="Stencil.jar" toDir="TestData"/>
        
        <junit fork="yes" dir="./">
            <classpath>
                <pathelement location="./TestData/Stencil.jar"/>
                <pathelement path="${testsLocation}"/>
                <pathelement path="${java.class.path}"/>
                <pathelement path="."/>
                <fileset dir="${runtimeLibrary}" includes="**/*.jar"/>
            </classpath>
            <test name="stencil.unittests.TestConfigure"/>
            <formatter type="plain"/>
        </junit>
    </target>


	<!--GUnit tests--> 	
 	<target name="GUnit" depends="MakeJar"> 
	 	<property name="testsLocation" location="bin/stencil/unittests/parser/string/grammars/" />

		<java classname="org.antlr.gunit.Interp" fork="yes" dir="${target}">
			<classpath>
				<pathelement path="${testsLocation}"/>
				<pathelement path="${java.class.path}"/>
				<pathelement path="."/>
			    <fileset dir="${runtimeLibrary}" includes="*.jar"/>
			</classpath>
			<arg value="${testsLocation}/Stencil.gunit"/>
		</java>
		<java classname="org.antlr.gunit.Interp" fork="yes" dir="${target}">
			<classpath>
				<pathelement path="${testsLocation}"/>
				<pathelement path="${java.class.path}"/>
				<pathelement path="."/>
			    <fileset dir="${runtimeLibrary}" includes="*.jar"/>
			</classpath>
			<arg value="${testsLocation}/SigilArgs.gunit"/>
		</java>
 		
 		<delete file="${runtimeLibrary}/Stencil.jar"/>
	</target>
 	
 	
 	<target name="GenerateRegressionImages" depends="MakeJar">
 	  <java jar="Stencil.jar" fork="yes" dir="TestData">
 	  	<arg value="-batch"/>
 	  	<arg value="-open"/>
	  	<arg value="RegressionImages/testSet.stencils" />
 	  	<arg value="-settings"/>
 	  	<arg value="Stencil.properties"/>
 	  	<arg value="Explore.properties"/>
 	  </java>
 	</target>
 	   
 </project>
