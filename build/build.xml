<!--If ANTLR3 task is not already installed, this script should be run with
    "-lib ./Library/antlr3-ant.jar" /-->
    
 <project name="Stencil" default="Stencil" basedir="..">
 	<taskdef resource="net/sf/antcontrib/antlib.xml"/>
 	<taskdef resource="org/apache/tools/ant/antlr/antlib.xml"/>
 	
 	<property name="src" location="Core" />
 	<property name="target" location="bin" />
 	<property name="runtimeLibrary" location="./Library/"/>
 	<property name="grammars" location ="${src}/stencil/parser/grammars/"/>
 	<property name="parser" location ="${src}/stencil/parser/string/"/>
 	<property name="ast" location ="${src}/stencil/parser/tree/"/>
 	<property name="interpreter" location ="${src}/stencil/interpreter/"/>
 	 	
 	
	<!-- Just the core stencil grammar, not the additional processing.-->
 	<target name="WorkingGrammar">
 		<antlr3
			target="${grammars}/transformers/OperatorInlineSimple.g"
			outputdirectory="${parser}"
		/>
 	</target>
 		
 		
 	<target name="Stencil" depends="GuideSystem, Transformers, TreeAdapter, Validators, Interpreter">
		<javac srcdir="${src}" destdir="${target}">
			<classpath><fileset dir="${runtimeLibrary}" includes="*.jar"/></classpath>
			<!-- compilerarg value="-Xlint"/ -->
		</javac>
 	</target>

	<!-- Just the core stencil grammar, not the additional processing.-->
 	<target name="StencilGrammar">
 		<antlr3
			target="${grammars}/Stencil.g"
			outputdirectory="${parser}"
		/>
 	</target>

 	
 	<!--All of the tree manipulations prior to the interpreter-->
    <target name="Transformers" depends="StencilGrammar">
        <foreach target="antlrBuild" param="file" inheritall="true">
            <fileset dir="${grammars}/transformers"/>
            <param name="antlrTarget" value="${parser}"/>
        </foreach>
    </target>

    <target name="GuideSystem" depends="StencilGrammar">
        <foreach target="antlrBuild" param="file" inheritall="true">
            <fileset dir="${grammars}/guide"/>
        	<param name="antlrTarget" value="${parser}"/>
        </foreach>
    </target>
    	    
 	
    <target name="Validators" depends="StencilGrammar">
    	<foreach target="antlrBuild" param="file" inheritall="true">
    	   <fileset dir="${grammars}/validators" />
           <param name="antlrTarget" value="${parser}/validators"/>
    	</foreach>
    </target>

    <target name="Interpreter" depends="StencilGrammar">
    	<foreach target="antlrBuild" param="file" inheritall="true">
    	   <fileset dir="${interpreter}" includes="*.g"/>
           <param name="antlrTarget" value="${interpreter}"/>
    	</foreach>
    </target>

 	
 	
 	<target name="antlrBuild">
        <antlr3
            target="${file}"
            outputdirectory="${antlrTarget}"
            libdirectory="${parser}"
        />          
    </target>
 	
 	<target name="TreeAdapterGrammar" depends="StencilGrammar">
 		<antlr3
 			target="${grammars}/StencilTreeAdapter.g"
 			outputdirectory="${ast}"
 		/>
	</target>

 	<target name="TreeAdapter" depends="TreeAdapterGrammar, StencilBuild">
		<java classname="stencil.util.build.GenerateTreeAdapter" fork="true">
			<classpath>
				<pathelement path="${target}"/>
				<pathelement path="${java.class.path}"/>
			    <fileset dir="${runtimeLibrary}" includes="*.jar"/>
			</classpath>
			<arg value="${parser}/Stencil.tokens" />
			<arg value="${grammars}/StencilTreeAdapter.stg" />
			<arg value="${ast}/StencilTreeAdapter.java" />
		</java>
 	</target>

 	<target name="StencilBuild">
 		<property name="dir" value="/stencil/util/build"/>
 		<mkdir dir="${target}${dir}" />
 		<javac sourcepath="" srcdir="${src}${dir}" destdir="${target}">
			<classpath><fileset dir="${runtimeLibrary}" includes="*.jar"/></classpath>
 		</javac>
 	</target>
 	
 	<target name="Release" depends="Stencil">
 		<ant antfile="./build/Deploy.xml" inheritRefs="true"/>
	</target> 
 	
	<!--GUnit tests--> 	
 	<target name="RunTests" depends="StencilGrammar"> 
 		<ant antfile="./build/Test.xml" inheritRefs="true"/>
	</target>
 </project>